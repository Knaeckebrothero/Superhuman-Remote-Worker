# =============================================================================
# Graph-RAG - VPN Overlay
# =============================================================================
#
# Adds VPN sidecars for university network access:
#   - vpn-cluster: Routes LLM API traffic to the compute cluster
#   - vpn-research: Routes research traffic for paywalled paper access
#
# Usage (production):
#   podman-compose -f docker-compose.yaml -f docker-compose.vpn.yaml up -d
#
# Usage (development):
#   podman-compose -f docker-compose.dev.yaml -f docker-compose.vpn.yaml up -d
#
# Agent routing â€” set in .env when using VPN:
#   LLM_BASE_URL=http://vpn-cluster:8080/v1
#   RESEARCH_PROXY_TYPE=socks5
#   RESEARCH_PROXY_HOST=vpn-research
#   RESEARCH_PROXY_PORT=1080
#
# Configuration:
#   Set VPN_CLUSTER_* and VPN_RESEARCH_* variables in .env, OR mount config
#   files at docker/vpn/cluster.conf and docker/vpn/research.conf.
#   Env vars take effect only when no config file is mounted.
#
#   SSL verification: place your university CA certificate at ./certs/ca.crt
#   (auto-detected), or use VPN_*_TRUSTED_CERT with a certificate hash.
#
# =============================================================================

services:
  vpn-cluster:
    image: ghcr.io/knaeckebrothero/superhuman-remote-worker-vpn:${IMAGE_TAG:-latest}
    container_name: graphrag-vpn-cluster
    privileged: true
    volumes:
      - ./certs:/etc/vpn/certs:ro
    environment:
      SOCKS_PORT: 1080
      FORWARD_PORT: 8080
      FORWARD_TARGET: ${VPN_CLUSTER_LLM_ENDPOINT:-}
      VPN_HOST: ${VPN_CLUSTER_HOST:-}
      VPN_PORT: ${VPN_CLUSTER_PORT:-443}
      VPN_REALM: ${VPN_CLUSTER_REALM:-}
      VPN_USER: ${VPN_CLUSTER_USER:-}
      VPN_PASS: ${VPN_CLUSTER_PASS:-}
      VPN_TRUSTED_CERT: ${VPN_CLUSTER_TRUSTED_CERT:-}
    healthcheck:
      test: ps aux | grep -q '[o]penfortivpn' && ps aux | grep -q '[m]icrosocks'
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  vpn-research:
    image: ghcr.io/knaeckebrothero/superhuman-remote-worker-vpn:${IMAGE_TAG:-latest}
    container_name: graphrag-vpn-research
    privileged: true
    volumes:
      - ./certs:/etc/vpn/certs:ro
    environment:
      SOCKS_PORT: 1080
      VPN_HOST: ${VPN_RESEARCH_HOST:-}
      VPN_PORT: ${VPN_RESEARCH_PORT:-443}
      VPN_REALM: ${VPN_RESEARCH_REALM:-}
      VPN_USER: ${VPN_RESEARCH_USER:-}
      VPN_PASS: ${VPN_RESEARCH_PASS:-}
      VPN_TRUSTED_CERT: ${VPN_RESEARCH_TRUSTED_CERT:-}
    healthcheck:
      test: ps aux | grep -q '[o]penfortivpn' && ps aux | grep -q '[m]icrosocks'
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
