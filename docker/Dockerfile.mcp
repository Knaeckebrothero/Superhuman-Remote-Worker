# =============================================================================
# MCP Server Dockerfile
# =============================================================================
#
# MCP server exposing orchestrator API to LLMs like Claude Code.
# Uses FastMCP 2.0 with dual transport support (stdio/HTTP).
#
# Build:
#   docker build -t graphrag-mcp -f docker/Dockerfile.mcp .
#
# Run (HTTP transport - default for container):
#   docker run -d --name mcp \
#     -p 8000:8000 \
#     -e COCKPIT_API_URL=http://orchestrator:8085 \
#     graphrag-mcp
#
# Run (stdio transport - for docker exec):
#   docker run -d --name mcp \
#     -e MCP_TRANSPORT=stdio \
#     -e COCKPIT_API_URL=http://orchestrator:8085 \
#     graphrag-mcp sleep infinity
#   docker exec -i mcp python run.py
# =============================================================================

FROM python:3.12-slim

LABEL maintainer="Graph-RAG Team"
LABEL description="MCP Server for Claude Code integration (FastMCP 2.0)"
LABEL org.opencontainers.image.source="https://github.com/knaeckebrothero/Uni-Projekt-Graph-RAG"

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Install curl for healthcheck
RUN apt-get update && apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Install dependencies
COPY orchestrator/mcp/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy MCP server source code
COPY orchestrator/mcp/ ./

# Create non-root user
RUN groupadd -r graphrag && useradd -r -g graphrag graphrag && \
    chown -R graphrag:graphrag /app

USER graphrag

# Default to HTTP for container deployment
ENV MCP_TRANSPORT=http \
    MCP_HOST=0.0.0.0 \
    MCP_PORT=8000 \
    COCKPIT_API_URL=http://orchestrator:8085

EXPOSE 8000

# Health check for Kubernetes readiness/liveness probes
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

CMD ["python", "run.py"]
